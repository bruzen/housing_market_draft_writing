- Fast version of the code where we track alternative bids/bid rent curves - actual bids/prices
    - Run on sharcnet
    - Show end grid
- Perturb mid way
- Fix error with crashing values
- Investors can sell

## Hypotheses
The financial sector affects the ownership of housing and the class structure of society, 
There may be dynamic/resilience features of this model that make the effects worse than you might expect
- Boom bust - pump wealth on/out of city on the boom and on the bust. 'There are sharks in the water' 1. Higher bid can amplify up swings - have to compete with speculators 2. can't get it back on down swing since outside finance offers a stable floor- buys up on way down (we expect larger effects as people are 1. displaced on the way up and then 2. evicted on the way down - can't use their spaces)
  - reduce demand for labour temporarily - reduce wages for labour - demand -- cyclic structure - local employment structure - and financial booms that are external.. - cases where they align and wehre they disalign
  - link finance and employment -vary price of output- vary the employment *** 
- Hysteresis - perturb, doesn't come back - e.g. interest rates go up.
- The way it aligns with long run changes in the landscape e.g. tech changing local info changes vulnerability to these shocks -- Depth of the basin changes - er   odes systemic resilience - together these changes bo the capacity to hold value in landscape. (links to the productivity feedback - much will/can they invest in increasing their productivity/supporting kids/good food to grow brains. Education to increase productivity is the feature that makes productivity increases resilient to de-industrialization)
This has implications for landscape- system- class structure- 

This may have implications for urban productivity. (can actually displace productive uses - empty store fronts) - who can/will enter, how , who can rent spaces, speculative value may keep it empty (work spaces or living space - lowering pop), reduces consumption


Amplified effects by extensions
Two city experiments
Different incomes  - inequality
Urban density



## High Priority
imediately do experiments with the price of output - should give a decline in price of labour, may or may not result in changes in the housing market (record housing prices]
Which interest rate is charged to investors
speed/memory, plot and workflow to find parameters, run online - try storing the bid rent curve -- - what is the gap.. 

just keep housing - turn off storage..  cyclic pieces turn off the market. - turn off the production






# List variable_parameters for experiments
experiment_parameters_list = [Jan 5
 {
    #   'density': [1, 10],
        # 'c': [3000, 300.0], 
    #   `'wealth_sensitivity': 0.1,
      'capital_gains_tax_person':   [0.5, 0.6],# 3, 4, 5], # share 0-1
    #   'capital_gains_tax_investor': [0.2, 0.3], # share 0-1
    #   'subsistence_wage': [40000], # [10000, 30000],
    #   'gamma': [0.001, 0.02, 0.7]
        'property_tax_rate': [.04, .08]
    },
    # {
    #     'density': [1, 100],
    #     'gamma': [0.001, 0.02, 0.7]
    # }

    {
    #   'density': [1, 10],
        'c': [3000, 300.0], 
    #   `'wealth_sensitivity': 0.1,
    #   'capital_gains_tax_person':   0.01, # share 0-1
    #   'capital_gains_tax_investor': 0.15, # share 0-1
    #   'subsistence_wage': [40000], # [10000, 30000],
    #   'gamma': [0.001, 0.02, 0.7]
    
    }
]

python(62894) MallocStackLogging: can't turn off malloc stack logging because it was not enabled.

Zeihan on Geopolitics YouTube Channel. Geopolitical Strategist Peter Zeihan is a global energy, demographic and security expert.


class City(Model):
    @property
    def city_extent_calc(self):
        # Compute urban boundary where it is not worthwhile to work
        return self.firm.wage_premium /  self.transport_cost_per_dist
#    @property
#     def populated_extent(self):
#         # Compute urban boundary where it is not worthwhile to work
#         return sqrt(self.N /  (self.density * 4))


pip install mesa


print(mesa.__version__)
https://www.youtube.com/watch?v=WJE7g08NldQ shipping thiefs

(base) david-robinsons-computer-3:housing_app drdavidrobinson$ conda update -n base -c defaults conda
Collecting package metadata (repodata.json): done
Solving environment: -
The environment is inconsistent, please check the package plan carefully
The following packages are causing the inconsistency:

  - https://repo.continuum.io/pkgs/main/osx-64/osx-64::blaze==0.11.3=py36_0
  - https://repo.continuum.io/pkgs/main/osx-64/osx-64::flask-cors==3.0.7=py36_0
  - defaults/osx-64::_anaconda_depends==2019.10=py36_0
  - defaults/osx-64::anaconda==custom=py36_1
  - defaults/noarch::flask==1.1.2=pyhd3eb1b0_0

  

curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python get-pip.py

python -m pip install --upgrade pip

conda update -n base -c defaults conda

 conda env create -f environment.yml -n housing


    
conda deactivate
conda env remove --name housing
conda env create -f environment.yml
conda activate <environment_name>   

https://studiolab.sagemaker.aws/users/kirsten

source activate housing
conda install -c conda-forge mesa
avid-robinsons-computer-3:housing_app drdavidrobinson$ conda env create -f environment.yml -n housing
Collecting package metadata (repodata.json): done
Solving environment: failed

ResolvePackageNotFound:
  - text-unidecode==1.3=pyhd8ed1ab_1
  - markdown-it-py==3.0.0=pyhd8ed1ab_0
  - starlette==0.33.0=pyhd8ed1ab_0
  - mesa-viz-tornado==0.1.3=pyhd8ed1ab_0
  - websockets==12.0=py39ha09f3b3_0
  - ipyvue==1.10.1=pyhd8ed1ab_0
  - pymdown-extensions==10.5=pyhd8ed1ab_0
  - ca-certificates==2023.11.17=h8857fd0_0
  - types-python-dateutil==2.8.19.14=pyhd8ed1ab_0
  - uvicorn==0.24.0.post1=py39h6e9494a_0
  - watchdog==3.0.0=py39h4cd3b3e_1
  - certifi==2023.11.17=pyhd8ed1ab_0
  - filelock==3.13.1=pyhd8ed1ab_0
  - humanize==4.9.0=pyhd8ed1ab_0
  - rich-click==1.7.2=pyhd8ed1ab_0
  - reacton==1.8.1=pyhd8ed1ab_0
  - ipyvuetify==1.8.10=pyhd8ed1ab_0
  - solara==1.25.0=pyhd8ed1ab_0
  - openssl==3.2.0=hd75f5a5_1
  - watchfiles==0.21.0=py39h3f9c672_0
  

https://www.generationatomic.org/
https://www.facebook.com/generationatomic/

k4robins@uwaterloo.ca


Here is the complete list. ones want to see are pulled to the left margin
Example - Bar cross bottom?  This would be easy to crop out. Latex needs us to label figures in the document not in the figure.

Experiment title. 'adjF': 0.02, 'adjw': 0.05,'discount_rate': 0.07,'r_margin': 0.01, CGT_person':   0.0, # share 0-1,  CGT_investor': 1, # share 0-1

'adjF'
'adjw'
'discount_rate'
'r_margin'
'max_mortgage_share'
'capital_gains_tax_person'
'capital_gains_tax_investor'


        # LABOUR MARKET AND FIRM PARAMETERS
            'subsistence_wage': 40000., # psi
            'init_city_extent': 10.,    # CUT OR CHANGE?
            'seed_population': 400,
            'init_wage_premium_ratio': 0.2, # 1.2, ###

            # PARAMETERS MOST LIKELY TO AFFECT SCALE
            'c': 300                             ### .0,                            ###
            'price_of_output': 10,                 ######
            'density':600,                         #####
            'A': 3000,
            'alpha': 0.18,
            'beta':  0.75,
            'gamma': 0.12, ### reduced from .14
            'overhead': 1.5,
            'mult': 1.2,
            'adjN': 0.15,
            'adjk': 0.10,
            'adjn': 0.15,
'adjF': 0.02,
'adjw': 0.05, 
            'dist': 1, 
            'init_F': 100.0,
            'init_k': 500.0,
            'init_n': 100.0,

            # HOUSING AND MORTGAGE MARKET PARAMETERS
            'mortgage_period': 5.0,       # T, in years
            'working_periods': 40,        # in years
            'savings_rate': 0.3,
'discount_rate': 0.07,        # 1/delta    Check THIS
            'r_prime': 0.05,
'r_margin': 0.01,
            'property_tax_rate': 0.04,     # tau, annual rate, was c
            'housing_services_share': 0.3, # a
            'maintenance_share': 0.2,      # b
'max_mortgage_share': 0.9,
            'ability_to_carry_mortgage': 0.28,
            'wealth_sensitivity': 0.1,
'capital_gains_tax_person':   0.0, # share 0-1
'capital_gains_tax_investor': 1, # share 0-1
 

\section{needed experiments Dec 14 DR}
\begin{enumerate}
    \item capital gains tax matters - find if there is a phase boundary - i.i. where in 

            'capital_gains_tax_person': [0.5, 0.01], # share 0-1

            'capital_gains_tax_investor': [0.5, 0.1], # share 0-1

            does investor share begin to rise (defined as ``for a given number of steps - say 70 - where is $Z=share_t - share_{t-1} \ge 0$? ) and where does it fall.

Maybe just store Z and and draw contour lines - there has to be as program for that.
\end{enumerate}
\section{parameter values form DR}
batch_parameters = {
            'data_collection_period': 1,
            'iterations': 1,
            'max_steps': 200
}

# List variable_parameters for experiments
    experiment_parameters_list = [
         {
            #'density': [800, 600],# 400, 200],
            'subsistence_wage':[40000],#[90000],[ 50000, 40000, 30000]
            #'gamma': [0.1, 0.09, 0.08 ]
            #'discount_rate': [.1, .8, .7, .6, .5]
            #'max_mortgage_share': [1.0, 0.9, 0.8, 0.7, 0.6]
            #'wealth_sensitivity': [0.1, .03, .05]
            #'ability_to_carry_mortgage': [0.35, 0.28, 0.2]
            #'savings_rate': [0.5, 0.3, 0.1]
        },
        # {
        #     'density': [1, 100],
        #     'subsistence_wage': [10000, 30000]
        # },
        # {
        #     'density': [1, 100],
        #     'gamma': [0.001, 0.02, 0.7]
        # }
    ]
    
    # Define fixed parameters, replaced by variable_parameters if there is a conflict
    fixed_parameters = {
                'run_notes': 'Debugging model.',
                'subfolder': None,
                'width':     50, #30,
                'height':    50, #30,
    
                # FLAGS
                'demographics_on': True,  # Set flag to False for debugging to check firm behaviour without demographics or housing market
                'center_city':     False, # Flag for city center in center if True, or bottom corner if False
                # 'random_init_age': False,  # Flag for randomizing initial age. If False, all workers begin at age 0
                'random_init_age': True,  # Flag for randomizing initial age. If False, all workers begin at age 0
    
                # LABOUR MARKET AND FIRM PARAMETERS
                'subsistence_wage': 40000., # psi
                'init_city_extent': 10.,    # CUT OR CHANGE?
                'seed_population': 400,
                'init_wage_premium_ratio': 0.2, # 1.2, ###
    
                # PARAMETERS MOST LIKELY TO AFFECT SCALE
                'c': 300.0,                            ###
                'price_of_output': 10,                 ######
                'density':600,                         #####
                'A': 3000,                             ### 
                'alpha': 0.18,
                'beta':  0.75,
                'gamma': 0.12, ### reduced from .14
                'overhead': 1.5,
                'mult': 1.2,
                'adjN': 0.15,
                'adjk': 0.10,
                'adjn': 0.15,
                'adjF': 0.02,
                'adjw': 0.02, 
                'dist': 1, 
                'init_F': 100.0,
                'init_k': 500.0,
                'init_n': 100.0,
    
                # HOUSING AND MORTGAGE MARKET PARAMETERS
                'mortgage_period': 5.0,       # T, in years
                'working_periods': 40,        # in years
                'savings_rate': 0.3,
                'discount_rate': 0.07,        # 1/delta
                'r_prime': 0.05,
                'r_margin': 0.01,
                'property_tax_rate': 0.04,     # tau, annual rate, was c
                'housing_services_share': 0.3, # a
                'maintenance_share': 0.2,      # b
                'max_mortgage_share': 0.9,
                'ability_to_carry_mortgage': 0.28,
                'wealth_sensitivity': 0.1,
            }


ownership

MPL     n
N       F
extent  k   % I just removed N/f because by def'n N=Fn, I think 
ownership       

Experiments. thinking about this. I am interested in tests to fine-tune the model but let's instead go on to work with the determinants of ownership. 



navigate to the housing_app folder in Terminal. cd Devel/housing_app
source activate housing
python batch_run.py


July 8 DRR

The price a property might sell at would be $\omega - {dc} + \mathbb{A} + rural-op-cost + conversion cost$. For simplicity, we drop the last two terms. Conversion cost would be amortized over a very long period and would be small in any case. We have hidden the rural-op-cost in $a\psi$.


Equation~\ref{eqn-property-investment-return2} implies a `bang-bang' control---with all sales going to the richest participant unless there are limits on the size of capital flows. For our simulation, we implement such limits.  Removed from Ch modle 


---

THIS IS THE CODE THAT I HAVE WORKING
The figure simply shows that both variables behave as expected.
because there is no lag and no partial adjustments it all happens in the first 5 cycles.


Changes are indicated with a training ######

import matplotlib.pyplot as plt

# Initialize variables
A     = 10
gamma =1.2
transport_cost_per_dist = 1
population = 1000
transport_cost_per_dist = 4
density = 10
seed_population = 0
#P=10000
t = []
wage_premium_list = []
population_list   = []
P_list            = []   ######

for time_step in range (10):
    # Calculate wage premium and population #REVERSE ORDER
    wage_premium = gamma*A * population**(gamma-1) #actually this was wage
    population =  2*(wage_premium / transport_cost_per_dist)**2 * density + seed_population
    P = population/100  ######
    
    # wage_premium = gamma*A * population**(gamma-1)#actually this is wage
    # population = 2*(wage_premium / transport_cost_per_dist)**2 * density + seed_population

    # Record output
    t.append(time_step)
    wage_premium_list.append(wage_premium)
    population_list.append(population)
    P_list.append(P)    ############

# Plot wage premium and population against time
import matplotlib.pyplot as plt

# IS THIS THE SINGLE FIGURE   Sept 9 YES
plt.figure(figsize=(10, 6))
plt.plot(t, wage_premium_list, label='Wage Premium')
#plt.plot(t, population_list, label='Population')######
plt.plot(t, P_list, label='Population/100')      ######
plt.ylabel('Value')
plt.xlabel('Time')
plt.title('Population and Wage Premium Over Time')
plt.legend()
plt.show()



 

 ax.set_ylabel(model_out_key, fontsize=20)

 figure 6.1 model logic says we are up in the uppeer block. This is what we need to unpack more. There is a cycle that has to work:

(productivity + wage) -> adjust(wage, n) -> population -> productivity 
 
How can people go up when workers goes down?

why does it start removing agents at step 35


Pushed another change

#add horizontal and vertical reference lines
plt.axhline(y = 0, xmin = 0., color ='black')# zero 
plt.axvline(x = 10, ymin = 0., color ='red')
plt.text(10.5, 400000, r'intitial city boundary', fontsize=15)
plt.text(1, 7000, r'zero rent', fontsize=15)

type
git stash
then 
git pull origin master





"distance_from_center": lambda a: getattr(a, "distance_from_center", None) if isinstance(a, Land) else None,


---

        }
        agent_reporters      = {
            "time_step":         lambda a: a.model.time_step,
            "agent_class":       lambda a: type(a),
            "agent_type":        lambda a: type(a).__name__,
            "id":                lambda a: a.unique_id,
            "x":                 lambda a: a.pos[0],
            "y":                 lambda a: a.pos[1],
            "distance_from_center": lambda a: getattr(a, "distance_from_center", None) if isinstance(a, Land) else None,
            "wage":                 lambda a: getattr(a, "wage", None) if isinstance(a, Land) else None,
            "is_working":           lambda a: None if not isinstance(a, Person) else 1 if a.unique_id in a.workforce.workers else 0,
            # "is_working":        lambda a: getattr(a, "is_working", None),
            "working_period":    lambda a: getattr(a, "working_period", None),
            "property_tax_rate": lambda a: getattr(a, "property_tax_rate", None),
            "net_rent":          lambda a: getattr(a, "net_rent", None) if isinstance(a, Land) else None,
            "warranted_price":   lambda a: getattr(a, "warranted_price", None) if isinstance(a, Land) else None,
        }




KeyError                                  Traceback (most recent call last)
File ~/anaconda/envs/housing/lib/python3.9/site-packages/pandas/core/indexes/base.py:3629, in Index.get_loc(self, key, method, tolerance)
   3628 try:
-> 3629     return self._engine.get_loc(casted_key)
   3630 except KeyError as err:

File ~/anaconda/envs/housing/lib/python3.9/site-packages/pandas/_libs/index.pyx:136, in pandas._libs.index.IndexEngine.get_loc()

File ~/anaconda/envs/housing/lib/python3.9/site-packages/pandas/_libs/index.pyx:163, in pandas._libs.index.IndexEngine.get_loc()

File pandas/_libs/hashtable_class_helper.pxi:5198, in pandas._libs.hashtable.PyObjectHashTable.get_item()

File pandas/_libs/hashtable_class_helper.pxi:5206, in pandas._libs.hashtable.PyObjectHashTable.get_item()

KeyError: 'distance_from_center'

The above exception was the direct cause of the following exception:

KeyError                                  Traceback (most recent call last)
Cell In[120], line 49
     46 axs[0, i].grid(False)
     48 # Create scatter plot for distance from center vs warranted price
---> 49 scatter = axs[1, i].scatter(land_agents['distance_from_center'], land_agents['warranted_price'], c='blue', alpha=0.5)
     50 axs[1, i].set_title(f'Distance vs Warranted Price at Time Step {time_step}')
     51 axs[1, i].set_xlabel('Distance from Center')

File ~/anaconda/envs/housing/lib/python3.9/site-packages/pandas/core/frame.py:3505, in DataFrame.__getitem__(self, key)
   3503 if self.columns.nlevels > 1:
   3504     return self._getitem_multilevel(key)
-> 3505 indexer = self.columns.get_loc(key)
   3506 if is_integer(indexer):
   3507     indexer = [indexer]

File ~/anaconda/envs/housing/lib/python3.9/site-packages/pandas/core/indexes/base.py:3631, in Index.get_loc(self, key, method, tolerance)
   3629     return self._engine.get_loc(casted_key)
   3630 except KeyError as err:
-> 3631     raise KeyError(key) from err
   3632 except TypeError:
   3633     # If we have a listlike key, _check_indexing_error will raise
   3634     #  InvalidIndexError. Otherwise we fall through and re-raise
   3635     #  the TypeError.
   3636     self._check_indexing_error(key)

KeyError: 'distance_from_center'